# 運用ガイド

このドキュメントは、AWS Pricing Calculator 見積もり合算ツールの運用担当者向けのガイドです。

## 目次

1. [デプロイメント](#デプロイメント)
2. [監視と運用](#監視と運用)
3. [バックアップとリカバリ](#バックアップとリカバリ)
4. [セキュリティ](#セキュリティ)
5. [スケーリング](#スケーリング)
6. [トラブルシューティング](#トラブルシューティング)
7. [定期メンテナンス](#定期メンテナンス)

## デプロイメント

### 環境構成

このアプリケーションは以下の環境にデプロイされます：

- **開発環境**: 新機能のテストと開発者向け検証環境
- **ステージング環境**: QA検証と本番前動作確認環境
- **本番環境**: エンドユーザー向け本番環境

### デプロイ手順

#### 自動デプロイ

CI/CDパイプラインを通じた自動デプロイが推奨されます：

1. GitHubリポジトリで該当ブランチにマージ:
   - `develop` -> 開発環境
   - `main` -> 本番環境（承認後）

2. GitHub Actionsが自動的にデプロイを実行

#### 手動デプロイ

必要に応じて、AWS CDKを使用して手動でデプロイできます：

```bash
# CDK環境の準備
cd cdk
npm install

# 開発環境へのデプロイ
npm run deploy:dev

# 本番環境へのデプロイ
npm run deploy:prod
```

### ロールバック手順

問題が発生した場合のロールバック手順：

1. AWS ECSコンソールから該当サービスを選択
2. 「更新」→「新しいデプロイの強制」→以前のタスク定義を選択
3. または、CDKを使用して以前のバージョンをデプロイ:

```bash
cd cdk
npm run deploy:prod -- --parameters version=X.Y.Z
```

## 監視と運用

### 監視ダッシュボード

以下のダッシュボードで監視を行います：

1. **CloudWatch Dashboards**:
   - URL: https://console.aws.amazon.com/cloudwatch/home?region=ap-northeast-1#dashboards:name=CalculatorMergerDashboard

2. **ECS Clusters Dashboard**:
   - URL: https://console.aws.amazon.com/ecs/home?region=ap-northeast-1#/clusters

### アラート設定

以下のアラートが設定されています：

| アラート名 | 説明 | しきい値 | 通知先 |
|------------|------|----------|--------|
| CPU使用率 | CPU使用率が高い | > 80%, 3分間 | OpsチームSlackチャンネル |
| メモリ使用率 | メモリ使用率が高い | > 80%, 3分間 | OpsチームSlackチャンネル |
| 5XXエラー | サーバーエラー率 | > 5%, 5分間 | OpsチームSlackチャンネル、開発者チーム |
| ALB健全性 | ターゲットグループの異常 | 異常ホスト > 50% | OpsチームSlackチャンネル |

### ログ分析

ログは以下の場所に保存されます：

```
/aws/ecs/aws-calculator-merger-prod
```

主要なログイベントパターン：

- `ERROR` - アプリケーションエラー
- `WARNING` - 注意が必要な状況
- `INFO:ACCESS` - APIアクセスログ

ログインサイト利用例：

```
filter @message like /ERROR/
| fields @timestamp, @message
| sort @timestamp desc
| limit 20
```

## バックアップとリカバリ

### データバックアップ

マージされた見積もりデータは定期的にバックアップされます：

1. **EFSバックアップ**:
   - AWS Backupで毎日自動バックアップ
   - 保持期間: 30日
   - バックアップウィンドウ: 03:00-05:00 UTC

2. **ECRイメージバックアップ**:
   - 各リリースタグのイメージを保持
   - 最新の10イメージを常に維持

### リカバリ手順

1. **EFSデータのリカバリ**:
   - AWS Backupコンソールから対象のバックアップを選択
   - 「リストア」を選択し、新しいEFSまたは既存のEFSに復元

2. **アプリケーションのリカバリ**:
   - 以前のバージョンのECRイメージでECSタスク定義を更新
   - 新しいECSタスクをデプロイ

## セキュリティ

### 認証と認可

アプリケーションは現在、認証を要求していません（公開ウェブアプリケーション）。
将来的には以下の実装を検討:

- AmazonCognito認証
- IAM統合

### ネットワークセキュリティ

以下のセキュリティ対策が適用されています：

1. **WAF設定**:
   - SQLインジェクション対策ルール
   - レート制限 (1000 req/IP/5分)
   - 地理的制限（オプション）

2. **セキュリティグループ**:
   - ALB: 80/443ポートのみ公開
   - ECSタスク: ALBからのトラフィックのみ許可
   - RDS/EFS: VPC内部からのアクセスのみ許可

### コンプライアンス対応

本システムでは以下のコンプライアンス要件を考慮:

- データは常に暗号化（転送中および保存時）
- アクセスログは最低90日間保持
- セキュリティ監査ログは最低1年間保持

## スケーリング

### 自動スケーリング設定

以下のスケーリング設定が適用されています：

1. **ターゲット追跡スケーリング**:
   - CPU使用率: 60%
   - スケールイン/アウトのクールダウン: 60秒

2. **ステップスケーリング**:
   - リクエスト数 > 800 req/min: +1 タスク
   - リクエスト数 > 1500 req/min: +2 タスク
   - リクエスト数 < 100 req/min: -1 タスク

3. **スケジュールスケーリング**:
   - 業務時間 (8:00-18:00): 最小4タスク
   - 夜間 (18:00-8:00): 最小2タスク

### 手動スケーリング手順

必要に応じて手動でスケーリングを行う手順:

1. AWS ECSコンソールにログイン
2. 該当するサービスを選択
3. 「更新」→「希望するタスク数」を変更
4. 「更新」ボタンをクリック

## トラブルシューティング

### 一般的な問題と解決策

#### 1. アプリケーションが起動しない

**チェック項目**:
- ECSサービスのイベントログ
- CloudWatchログで起動エラー
- タスク定義の環境変数

**解決策**:
- エラーログを確認し、問題を特定
- 正しい環境変数が設定されているか確認
- 必要に応じて手動でタスクを再起動

#### 2. パフォーマンス問題

**チェック項目**:
- CloudWatchメトリクス (CPU, メモリ使用率)
- アプリケーションログでスロークエリ
- ALB接続状態

**解決策**:
- スケーリングポリシーの調整
- 必要に応じて垂直スケーリング (タスク定義のCPU/メモリを増加)
- コードの最適化 (プロファイリング結果に基づく)

#### 3. 特定のURLの処理エラー

**チェック項目**:
- アプリケーションログで特定のリクエストのエラー
- AWS Pricing Calculator URLの形式
- JSONデータの整合性

**解決策**:
- エラーログから問題のあるURLを特定
- 見積もりデータの構造変更がないか確認
- 必要に応じてパーサーコードを更新

### サポートプロセス

問題発生時のエスカレーションフロー:

1. L1サポート: アプリケーションログ確認と基本的な問題解決
2. L2サポート: 開発チームのオンコール担当者
3. L3サポート: アプリケーション開発責任者

緊急連絡先:
- 平日業務時間: Slackチャンネル `#calculator-merger-support`
- 時間外緊急: オンコール電話 (ローテーション表に従う)

## 定期メンテナンス

### メンテナンススケジュール

以下の定期メンテナンスを実施:

1. **セキュリティパッチ適用**:
   - スケジュール: 毎月第2火曜日 03:00-05:00 UTC
   - 手順: 新しいDockerイメージのビルドとデプロイ

2. **依存パッケージ更新**:
   - スケジュール: 四半期ごと
   - 手順: 依存パッケージのバージョンアップデートとテスト

3. **リソース使用率レビュー**:
   - スケジュール: 毎週月曜日
   - 手順: CloudWatchメトリクスのレビューとキャパシティ計画

### メンテナンス通知

メンテナンス実施前の通知プロセス:

1. 計画メンテナンス: 1週間前にユーザーに通知
2. 緊急メンテナンス: 可能な限り早急に通知（最低2時間前）
3. 通知方法: バナー表示、メール通知、Slack通知
